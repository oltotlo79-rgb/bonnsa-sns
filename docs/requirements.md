# BON-LOG 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト情報

| 項目 | 内容 |
|------|------|
| プロジェクト名 | BON-LOG（ボンログ） |
| 概要 | 盆栽愛好家向けのソーシャルネットワークサービス |
| 本番URL | https://www.bon-log.com |
| リポジトリ | GitHub (プライベート) |

### 1.2 目的

盆栽愛好家向けのSNSプラットフォームを構築し、以下を実現する：
- 盆栽に関する画像・動画投稿と情報共有
- 盆栽園マップによる店舗情報の共有
- イベント情報の掲載と共有
- 盆栽の成長記録管理

### 1.3 ターゲットユーザー

| ユーザー層 | 主な利用目的 |
|-----------|-------------|
| 盆栽愛好家 | 日々の管理記録、作品共有、情報交換 |
| 盆栽初心者 | 育成方法の学習、コミュニティ参加 |
| 盆栽園経営者 | 店舗情報掲載、集客、イベント告知 |
| イベント主催者 | 展示会・イベント情報の告知 |

### 1.4 ビジネスモデル

| 収益源 | 状態 | 内容 |
|--------|------|------|
| プレミアム会員 | 実装済み | 月額350円 / 年額3,500円 |
| 広告掲載 | 実装済み | Google AdSense |

---

## 2. 技術スタック

### 2.1 フロントエンド

| 技術 | バージョン | 用途 |
|------|-----------|------|
| Next.js | 16 (App Router) | フレームワーク |
| React | 19 | UIライブラリ |
| TypeScript | 5.x | 型安全な開発 |
| Tailwind CSS | 4 | スタイリング |
| shadcn/ui | - | UIコンポーネント |
| Zustand | - | クライアント状態管理 |
| React Query | - | サーバー状態管理 |
| Leaflet | - | 地図表示 |

### 2.2 バックエンド

| 技術 | 用途 |
|------|------|
| Next.js Server Actions | API実装 |
| NextAuth.js v5 | 認証 |
| Prisma | ORM |
| Zod | バリデーション |
| otplib | TOTP（2段階認証） |
| FingerprintJS | デバイス識別 |

### 2.3 インフラストラクチャ

| サービス | 用途 | プラン |
|---------|------|--------|
| Vercel | ホスティング | Pro ($20/月) |
| Supabase | PostgreSQLデータベース | Free〜Pro |
| Upstash | Redis（キャッシュ・レート制限） | Free |
| Cloudflare R2 | 画像・動画ストレージ | 従量課金 |
| Resend | メール送信 | Free (100通/日) |
| Stripe | 決済処理 | 従量課金 |
| Sentry | エラー監視 | Free (5,000エラー/月) |

### 2.4 サービス選定理由

| サービス | 選定理由 |
|---------|---------|
| Vercel | Next.jsとの最高の親和性、自動スケーリング、Edge Network |
| Supabase | PostgreSQL + 接続プーリング、マネージドサービス |
| Upstash | サーバーレスRedis、REST API対応、Vercel統合 |
| Cloudflare R2 | S3互換API、エグレス料金無料、低コスト |
| Resend | シンプルなAPI、高い配信率、無料枠あり |
| Sentry | Next.js公式対応、詳細なエラートラッキング |

---

## 3. 機能仕様

### 3.1 認証機能

#### 3.1.1 ユーザー登録
- メールアドレス + パスワードによる登録
- パスワード要件:
  - 8文字以上
  - アルファベット（a-z, A-Z）を1文字以上含む
  - 数字（0-9）を1文字以上含む
- パスワードはbcryptでハッシュ化（ソルトラウンド10）
- メールアドレスブラックリストチェック
- デバイスフィンガープリントブラックリストチェック

#### 3.1.2 ログイン
- メールアドレス + パスワード認証
- NextAuth.js (Auth.js v5) によるセッション管理
- JWT戦略によるセッショントークン
- ログイン履歴の記録（IPアドレス、ユーザーエージェント、成功/失敗）
- デバイスフィンガープリントブラックリストチェック
- 2段階認証（TOTP）対応（有効化している場合）

#### 3.1.3 セキュリティ対策
- ブルートフォース攻撃対策（Upstash Redisによるレート制限）
  - 5回連続失敗で15分間ロック
  - 失敗回数をRedisで追跡
- パスワードリセット
  - SHA-256ハッシュ化トークン
  - 1時間の有効期限
  - メールによるリセットリンク送信
  - IPベースのレート制限（1時間に3回まで）

#### 3.1.4 2段階認証（TOTP）
- Google Authenticator等のTOTPアプリ対応
- QRコードによるセットアップ
- 6桁の認証コード（30秒ごとに更新）
- バックアップコード（8桁 × 10個）
  - SHA-256ハッシュ化して保存
  - 使用済みコードは無効化
- TOTPシークレットはAES-256-GCMで暗号化して保存
- 設定ページ: `/settings/security`

#### 3.1.5 ブラックリスト機能
- **メールアドレスブラックリスト**
  - 登録禁止メールアドレスの管理
  - 管理者が追加/削除可能
  - 理由の記録

- **デバイスフィンガープリントブラックリスト**
  - FingerprintJSによるデバイス識別
  - 不正利用デバイスのブロック
  - 関連メールアドレスの記録
  - 登録時・ログイン時にチェック

### 3.2 投稿機能

#### 3.2.1 投稿種別

| 種別 | 説明 |
|------|------|
| 通常投稿 | テキスト + メディア（画像/動画） |
| 引用投稿 | 他の投稿を引用してコメント追加 |
| リポスト | 他の投稿をそのまま共有 |

#### 3.2.2 投稿制限

| 項目 | 無料会員 | プレミアム会員 |
|------|---------|---------------|
| 文字数 | 500文字 | 2,000文字 |
| 画像 | 4枚まで | 6枚まで |
| 動画 | 1本まで | 3本まで |
| 1日の投稿数 | 20件 | 20件 |

#### 3.2.3 メディア仕様

**画像:**
| 項目 | 仕様 |
|------|------|
| 対応形式 | JPEG, PNG, GIF, WebP |
| 最大サイズ | 4MB |
| 保存先 | Cloudflare R2 |
| セキュリティ | ファイルシグネチャ検証、UUIDファイル名 |

**動画:**
| 項目 | 仕様 |
|------|------|
| 対応形式 | MP4, WebM, MOV |
| 最大サイズ | 256MB |
| 保存先 | Cloudflare R2 |

#### 3.2.4 ジャンル

投稿には最大3つのジャンルを設定可能。

**松柏類（18種）:**
黒松、赤松、五葉松、真柏、杜松、檜、椹、檜葉/翌檜、杉、一位、キャラボク、蝦夷松、落葉松、米栂、樅木、榧、槙、その他松柏類

**雑木類（38種）:**
紅葉、楓、匂楓、銀杏、欅、楡欅、梅、長寿梅/木瓜、梅擬、蔓梅擬/岩梅蔓、縮緬蔓、金豆、ピラカンサ、花梨、台湾黄楊、イボタ、群雀、香丁木/白丁木、真弓、小真弓、ブナ、梔子、グミ、桜、皐月、椿、山茶花、柿、柘榴、百日紅、姫林檎/海棠、柊、針蔓柾、蔦、イヌビワ、紫式部、レンギョウ、その他雑木類

**その他:**
- 草もの（山野草、苔）
- 用品・道具（道具、薬剤・肥料、鉢、用土、その他）
- 施設・イベント（盆栽園、展示会/イベント）
- その他（管理方法、その他）

#### 3.2.5 その他の投稿機能

| 機能 | 説明 |
|------|------|
| ハッシュタグ | #から始まるタグを自動抽出・リンク化 |
| メンション | @ユーザー名で通知送信 |
| 下書き保存 | 投稿前に一時保存 |
| 予約投稿 | 指定日時に自動投稿（プレミアム限定） |

### 3.3 タイムライン

#### 3.3.1 表示内容
- 自分の投稿
- フォローしているユーザーの投稿
- ブロック/ミュートしたユーザーは除外

#### 3.3.2 ページネーション
- カーソルベースの無限スクロール
- 1回のロードで20件取得

### 3.4 ソーシャル機能

#### 3.4.1 いいね
- 投稿へのいいね
- コメントへのいいね
- いいね通知の送信

#### 3.4.2 コメント
- 投稿へのコメント
- コメントへのリプライ（スレッド形式）
- 1投稿あたり最大100件

#### 3.4.3 ブックマーク
- 投稿のブックマーク保存
- ブックマーク一覧ページ

#### 3.4.4 フォロー
- ユーザーのフォロー/アンフォロー
- フォロワー/フォロー中リスト
- フォローリクエスト機能（非公開アカウント用）
  - 承認/拒否の管理
  - リクエスト一覧ページ

#### 3.4.5 ブロック・ミュート

| 機能 | 効果 |
|------|------|
| ブロック | 相手の投稿が非表示、相手からも見えなくなる |
| ミュート | 相手の投稿がタイムラインに表示されない（フォロー維持） |

### 3.5 通知機能

#### 3.5.1 通知種別

| 種別 | トリガー |
|------|---------|
| like | 投稿にいいねされた |
| comment | 投稿にコメントされた |
| reply | コメントにリプライされた |
| follow | フォローされた |
| follow_request | フォローリクエストを受けた |
| follow_accept | フォローリクエストが承認された |
| quote | 投稿が引用された |
| comment_like | コメントにいいねされた |
| mention | @メンションされた |

#### 3.5.2 通知管理
- 一覧表示
- 既読/未読管理
- 個別削除

### 3.6 検索機能

#### 3.6.1 検索対象

| 対象 | 検索項目 |
|------|---------|
| 投稿 | 本文テキスト |
| ユーザー | ニックネーム |
| ハッシュタグ | タグ名 |

#### 3.6.2 検索仕様
- 複数ワードでのAND検索
- ハッシュタグ検索（#付き）
- ジャンルでのフィルタリング

### 3.7 盆栽園マップ

#### 3.7.1 盆栽園情報

| 項目 | 必須 | 説明 |
|------|------|------|
| 店名 | ○ | 盆栽園名 |
| 住所 | ○ | 都道府県〜番地 |
| 緯度・経度 | 自動 | 住所から自動取得 |
| 電話番号 | - | 連絡先 |
| ウェブサイト | - | URL |
| 営業時間 | - | テキスト形式 |
| 定休日 | - | テキスト形式 |
| ジャンル | - | 複数選択可 |

#### 3.7.2 盆栽園ジャンル
- サイズ: ミニ盆栽、小品盆栽、貴風盆栽、大品盆栽
- 用品: 道具、鉢、展示用具、肥料・用土・薬剤、書籍

#### 3.7.3 地図機能
- Leaflet + OpenStreetMap による地図表示
- マーカークリックで詳細表示
- 現在地からの距離表示

#### 3.7.4 ジオコーディング
- 国土地理院 住所検索APIを使用
- 住所入力時のオートコンプリート
- 住所から緯度経度を自動取得

#### 3.7.5 レビュー機能
- 星評価（1〜5段階）
- テキストコメント（任意）
- 画像添付（最大3枚）

### 3.8 イベント機能

#### 3.8.1 イベント情報

| 項目 | 必須 | 説明 |
|------|------|------|
| タイトル | ○ | イベント名 |
| 説明 | - | 詳細説明 |
| 開始日 | ○ | 開催開始日 |
| 終了日 | - | 開催終了日 |
| 都道府県 | ○ | 開催地域 |
| 市区町村 | - | 開催市区町村 |
| 会場名 | - | 会場名称 |
| 主催者 | - | 主催者名 |
| 入場料 | - | 料金情報 |
| 販売有無 | - | 物販の有無 |
| 外部URL | - | 詳細ページURL |

#### 3.8.2 地域フィルター

**8つの地方ブロック:**
- 北海道
- 東北（青森、岩手、宮城、秋田、山形、福島）
- 関東（茨城、栃木、群馬、埼玉、千葉、東京、神奈川）
- 中部（新潟、富山、石川、福井、山梨、長野、岐阜、静岡、愛知）
- 近畿（三重、滋賀、京都、大阪、兵庫、奈良、和歌山）
- 中国（鳥取、島根、岡山、広島、山口）
- 四国（徳島、香川、愛媛、高知）
- 九州・沖縄（福岡、佐賀、長崎、熊本、大分、宮崎、鹿児島、沖縄）

#### 3.8.3 表示仕様
- カレンダー形式での表示
- 終了したイベントは自動的に非表示
- 日付範囲でのフィルタリング

### 3.9 盆栽成長記録

#### 3.9.1 盆栽情報

| 項目 | 説明 |
|------|------|
| 盆栽名 | 識別用の名前 |
| 樹種 | 種類 |
| 取得日 | 入手日 |
| 説明 | 詳細メモ |

#### 3.9.2 成長記録
- テキスト + 画像（最大3枚）
- 記録日時の保存
- 時系列での一覧表示

### 3.10 ダイレクトメッセージ

#### 3.10.1 機能
- 1対1のメッセージ送受信
- 会話スレッド管理
- 既読/未読管理

### 3.11 プレミアム会員機能

#### 3.11.1 料金プラン

| プラン | 価格（税込） | 特典 |
|--------|-------------|------|
| 月額プラン | 350円/月 | 下記特典すべて |
| 年額プラン | 3,500円/年 | 2ヶ月分お得 |

#### 3.11.2 プレミアム特典

| 特典 | 説明 |
|------|------|
| 投稿文字数 | 最大2,000文字（通常500文字） |
| 画像添付 | 最大6枚（通常4枚） |
| 動画添付 | 最大3本（通常1本） |
| 予約投稿 | 指定日時の自動投稿 |
| アナリティクス | プロフィール閲覧数、投稿閲覧数、いいね数 |

#### 3.11.3 決済
- Stripe Checkoutによる決済
- クレジットカード対応
- 自動更新（サブスクリプション）
- カスタマーポータルでの管理
- Webhookによる決済イベント処理

### 3.12 通報・モデレーション

#### 3.12.1 通報理由

| 理由 | 説明 |
|------|------|
| spam | スパム |
| inappropriate | 不適切な内容 |
| harassment | 誹謗中傷 |
| copyright | 著作権侵害 |
| other | その他 |

#### 3.12.2 通報対象
- 投稿
- コメント
- イベント
- 盆栽園
- レビュー
- ユーザー

#### 3.12.3 自動モデレーション
- 同一コンテンツへの通報が10件を超えると自動非表示
- 自動非表示時は管理者に通知

### 3.13 管理者機能

#### 3.13.1 ダッシュボード
- 総ユーザー数 / 今日の新規ユーザー
- 総投稿数 / 今日の投稿数
- 未処理の通報数
- イベント総数 / 盆栽園総数
- 週間アクティブユーザー数
- 過去30日間の統計グラフ
- DAU（デイリーアクティブユーザー）

#### 3.13.2 ユーザー管理
- ユーザー一覧（検索、フィルター、ソート）
- ユーザー詳細表示
- ユーザー停止/復帰
- ユーザー完全削除

#### 3.13.3 コンテンツ管理
- 投稿管理（一覧、強制削除）
- イベント管理（一覧、削除）
- 盆栽園管理（一覧、削除）
- 非表示コンテンツ管理（確認、復元）

#### 3.13.4 通報管理
- 通報一覧
- ステータス管理（保留/確認済み/解決/却下）
- コンテンツの非表示/削除

#### 3.13.5 プレミアム会員管理
- プレミアム会員一覧
- 有効期限管理

#### 3.13.6 管理者ログ
- すべての管理者操作を記録
- アクション種別でのフィルタリング
- 日時、実行者、理由の記録

#### 3.13.7 ブラックリスト管理
- メールアドレスブラックリスト
  - 一覧表示（検索、ページネーション）
  - 追加（メールアドレス、理由）
  - 削除
- デバイスブラックリスト
  - 一覧表示（検索、ページネーション）
  - 追加（フィンガープリント、関連メール、理由）
  - 削除
- 管理画面: `/admin/blacklist`

#### 3.13.8 メンテナンスモード
- メンテナンスモードの有効/無効切り替え
- 予約メンテナンス（開始日時・終了日時の設定）
- カスタムメンテナンスメッセージ
- 管理者はメンテナンス中もアクセス可能
- 管理画面: `/admin/maintenance`

### 3.14 広告機能（Google AdSense）

#### 3.14.1 実装状況
- Google AdSenseコード統合済み
- 広告コンポーネント実装済み

#### 3.14.2 広告配置

| 配置場所 | コンポーネント | 説明 |
|---------|---------------|------|
| サイドバー | SidebarAd | 右サイドバー内の広告枠 |
| フィード内 | AdBanner | タイムライン内のインフィード広告 |
| 汎用 | GoogleAdSense | 任意の場所に配置可能 |

#### 3.14.3 環境変数

```bash
NEXT_PUBLIC_ADSENSE_CLIENT_ID="ca-pub-xxxxxxxxxx"
NEXT_PUBLIC_ADSENSE_SLOT_SIDEBAR="xxxxxxxxxx"
NEXT_PUBLIC_ADSENSE_SLOT_FEED="xxxxxxxxxx"
```

---

## 4. データベース設計

### 4.1 主要テーブル

#### ユーザー関連
| テーブル | 説明 |
|---------|------|
| users | ユーザー情報（2FAフィールド含む） |
| follows | フォロー関係 |
| follow_requests | フォローリクエスト |
| blocks | ブロック関係 |
| mutes | ミュート関係 |
| login_histories | ログイン履歴 |
| user_devices | ユーザーのデバイス情報 |

#### セキュリティ関連
| テーブル | 説明 |
|---------|------|
| email_blacklist | メールアドレスブラックリスト |
| device_blacklist | デバイスフィンガープリントブラックリスト |

#### 投稿関連
| テーブル | 説明 |
|---------|------|
| posts | 投稿 |
| post_media | 投稿メディア |
| post_genres | 投稿ジャンル |
| comments | コメント |
| likes | いいね |
| bookmarks | ブックマーク |
| hashtags | ハッシュタグ |
| post_hashtags | 投稿ハッシュタグ関連 |

#### 機能関連
| テーブル | 説明 |
|---------|------|
| genres | ジャンルマスタ |
| notifications | 通知 |
| draft_posts | 下書き |
| scheduled_posts | 予約投稿 |

#### 盆栽園・イベント
| テーブル | 説明 |
|---------|------|
| bonsai_shops | 盆栽園 |
| shop_genres | 盆栽園ジャンル |
| shop_reviews | 盆栽園レビュー |
| shop_review_images | レビュー画像 |
| events | イベント |

#### 盆栽記録
| テーブル | 説明 |
|---------|------|
| bonsais | 盆栽 |
| bonsai_records | 成長記録 |
| bonsai_record_images | 記録画像 |

#### メッセージ
| テーブル | 説明 |
|---------|------|
| conversations | 会話 |
| conversation_participants | 会話参加者 |
| messages | メッセージ |

#### 決済
| テーブル | 説明 |
|---------|------|
| payments | 支払い履歴 |

#### 管理
| テーブル | 説明 |
|---------|------|
| reports | 通報 |
| admin_users | 管理者 |
| admin_logs | 管理者ログ |
| admin_notifications | 管理者通知 |
| system_settings | システム設定（メンテナンスモード等） |

#### アナリティクス
| テーブル | 説明 |
|---------|------|
| user_analytics | ユーザー分析データ |

---

## 5. API設計

### 5.1 認証 API

| 関数 | 説明 |
|------|------|
| `registerUser` | ユーザー登録（ブラックリストチェック含む） |
| `checkLoginAllowed` | ログイン許可チェック |
| `recordLoginFailure` | ログイン失敗記録 |
| `clearLoginAttempts` | 失敗カウントクリア |
| `requestPasswordReset` | パスワードリセット要求（レート制限付き） |
| `resetPassword` | パスワードリセット実行 |

### 5.1.1 2段階認証 API

| 関数 | 説明 |
|------|------|
| `setup2FA` | 2FAセットアップ開始（QRコード生成） |
| `enable2FA` | 2FA有効化（TOTP検証後） |
| `disable2FA` | 2FA無効化（パスワード確認） |
| `verify2FAToken` | ログイン時の2FA検証 |
| `check2FARequired` | 2FA必要性チェック |
| `regenerateBackupCodes` | バックアップコード再生成 |
| `get2FAStatus` | 2FA状態取得 |

### 5.1.2 ブラックリスト API

| 関数 | 説明 |
|------|------|
| `addEmailToBlacklist` | メールアドレスをブラックリストに追加 |
| `removeEmailFromBlacklist` | メールアドレスをブラックリストから削除 |
| `getEmailBlacklist` | メールブラックリスト一覧取得 |
| `isEmailBlacklisted` | メールアドレスのブラックリストチェック |
| `addDeviceToBlacklist` | デバイスをブラックリストに追加 |
| `removeDeviceFromBlacklist` | デバイスをブラックリストから削除 |
| `getDeviceBlacklist` | デバイスブラックリスト一覧取得 |
| `isDeviceBlacklisted` | デバイスのブラックリストチェック |
| `recordUserDevice` | ユーザーのデバイス情報を記録 |

### 5.2 投稿 API

| 関数 | 説明 |
|------|------|
| `createPost` | 投稿作成 |
| `createQuotePost` | 引用投稿作成 |
| `createRepost` | リポスト作成/解除 |
| `deletePost` | 投稿削除 |
| `getPost` | 投稿取得 |
| `getPosts` | タイムライン取得 |

### 5.3 ソーシャル API

| 関数 | 説明 |
|------|------|
| `toggleLike` | いいね切り替え |
| `toggleBookmark` | ブックマーク切り替え |
| `toggleFollow` | フォロー切り替え |
| `toggleBlock` | ブロック切り替え |
| `toggleMute` | ミュート切り替え |
| `createComment` | コメント作成 |

### 5.4 フォローリクエスト API

| 関数 | 説明 |
|------|------|
| `getFollowRequests` | リクエスト一覧取得 |
| `acceptFollowRequest` | リクエスト承認 |
| `rejectFollowRequest` | リクエスト拒否 |

### 5.5 盆栽園 API

| 関数 | 説明 |
|------|------|
| `getShops` | 一覧取得 |
| `getShop` | 詳細取得 |
| `createShop` | 登録 |
| `updateShop` | 更新 |
| `deleteShop` | 削除 |
| `geocodeAddress` | ジオコーディング |
| `createShopReview` | レビュー作成 |

### 5.6 イベント API

| 関数 | 説明 |
|------|------|
| `getEvents` | 一覧取得 |
| `getEvent` | 詳細取得 |
| `createEvent` | 作成 |
| `updateEvent` | 更新 |
| `deleteEvent` | 削除 |

### 5.7 決済 API

| 関数 | 説明 |
|------|------|
| `createCheckoutSession` | 決済セッション作成 |
| `createCustomerPortalSession` | ポータルセッション作成 |
| `getSubscriptionStatus` | サブスクリプション状態取得 |

### 5.8 メンテナンス API

| 関数 | 説明 |
|------|------|
| `getMaintenanceSettings` | メンテナンス設定取得 |
| `updateMaintenanceSettings` | メンテナンス設定更新 |
| `isMaintenanceMode` | メンテナンスモード判定 |
| `toggleMaintenanceMode` | メンテナンス有効/無効切替 |

### 5.9 API Routes

| パス | 説明 |
|------|------|
| `/api/auth/[...nextauth]` | NextAuth.js認証 |
| `/api/upload/avatar` | アバターアップロード |
| `/api/upload/header` | ヘッダーアップロード |
| `/api/upload/presigned` | presigned URL発行（フォルダ検証付き） |
| `/api/cron/publish-scheduled` | 予約投稿実行 |
| `/api/cron/check-subscriptions` | サブスクリプション確認 |
| `/api/webhooks/stripe` | Stripe Webhook |
| `/api/health` | ヘルスチェック |
| `/api/maintenance/status` | メンテナンス状態確認 |

---

## 6. ページ構成

### 6.1 認証ページ

| パス | 説明 |
|------|------|
| `/login` | ログイン |
| `/register` | ユーザー登録 |
| `/password-reset` | パスワードリセット要求 |
| `/password-reset/confirm` | パスワードリセット実行 |

### 6.2 メインページ

| パス | 説明 |
|------|------|
| `/feed` | タイムライン |
| `/posts/[id]` | 投稿詳細 |
| `/bookmarks` | ブックマーク一覧 |
| `/drafts` | 下書き一覧 |
| `/search` | 検索結果 |
| `/notifications` | 通知一覧 |
| `/messages` | メッセージ一覧 |

### 6.3 ユーザーページ

| パス | 説明 |
|------|------|
| `/users/[id]` | プロフィール |
| `/users/[id]/posts` | ユーザーの投稿 |
| `/users/[id]/likes` | いいねした投稿 |
| `/users/[id]/followers` | フォロワー一覧 |
| `/users/[id]/following` | フォロー中一覧 |

### 6.4 盆栽園・イベント

| パス | 説明 |
|------|------|
| `/shops` | 盆栽園マップ |
| `/shops/new` | 盆栽園登録 |
| `/shops/[id]` | 盆栽園詳細 |
| `/events` | イベント一覧 |
| `/events/new` | イベント作成 |
| `/events/[id]` | イベント詳細 |

### 6.5 盆栽記録

| パス | 説明 |
|------|------|
| `/bonsai` | 盆栽一覧 |
| `/bonsai/new` | 盆栽登録 |
| `/bonsai/[id]` | 盆栽詳細 |

### 6.6 設定

| パス | 説明 |
|------|------|
| `/settings` | 設定メニュー |
| `/settings/profile` | プロフィール編集 |
| `/settings/account` | アカウント設定 |
| `/settings/security` | セキュリティ設定（2FA） |
| `/settings/subscription` | プレミアム会員 |
| `/settings/blocked` | ブロック一覧 |
| `/settings/muted` | ミュート一覧 |
| `/settings/follow-requests` | フォローリクエスト管理 |

### 6.7 管理者

| パス | 説明 |
|------|------|
| `/admin` | ダッシュボード |
| `/admin/users` | ユーザー管理 |
| `/admin/posts` | 投稿管理 |
| `/admin/events` | イベント管理 |
| `/admin/shops` | 盆栽園管理 |
| `/admin/reports` | 通報管理 |
| `/admin/blacklist` | ブラックリスト管理 |
| `/admin/maintenance` | メンテナンスモード管理 |
| `/admin/logs` | 管理者ログ |

### 6.8 静的ページ

| パス | 説明 |
|------|------|
| `/` | ホーム（LP） |
| `/about` | BON-LOGについて |
| `/terms` | 利用規約 |
| `/privacy` | プライバシーポリシー |
| `/tokushoho` | 特定商取引法に基づく表記 |
| `/help` | ヘルプ |
| `/contact` | お問い合わせ |
| `/maintenance` | メンテナンス中ページ |

---

## 7. セキュリティ

### 7.1 認証・認可
- NextAuth.js v5によるセッション管理
- JWT戦略
- CSRF保護（自動）

### 7.2 データ保護
- パスワード: bcryptハッシュ化（ソルトラウンド10）
- リセットトークン: SHA-256ハッシュ化
- 2FAシークレット: AES-256-GCM暗号化
- 2FAバックアップコード: SHA-256ハッシュ化
- SQLインジェクション対策: Prismaによるパラメータ化クエリ
- XSS対策: HTMLサニタイズ（sanitize.ts）

### 7.3 アクセス制御
- ログインレート制限（5回失敗で15分ロック）
- パスワードリセットレート制限（1時間に3回）
- 管理者権限の分離
- 自分のコンテンツのみ編集/削除可能
- 2段階認証（TOTP）によるアカウント保護
- メールアドレスブラックリストによる登録制限
- デバイスフィンガープリントブラックリストによるアクセス制限

### 7.4 ファイルアップロードセキュリティ
- ファイルシグネチャ（マジックバイト）検証
- MIMEタイプと実際のファイル形式の一致確認
- UUID v4によるファイル名生成（オリジナルファイル名非使用）
- presigned URLのフォルダ制限（ホワイトリスト方式）
- 対応ファイル形式の厳格な制限

### 7.5 入力検証・サニタイズ
- Zodによるスキーマバリデーション
- HTMLタグのサニタイズ（危険なタグ・属性の除去）
- 許可されたHTML要素のホワイトリスト管理

### 7.6 監視・ログ
- Sentryによるエラー監視
- 管理者操作のログ記録
- ログイン履歴の記録
- セキュリティイベントのロギング（security-logger.ts）

### 7.7 レート制限
- Upstash Redisによる分散レート制限
- エンドポイントごとのカスタマイズ可能な制限設定
- IPベース + ユーザーベースの制限

### 7.8 セキュリティヘッダー
- `X-XSS-Protection`: XSS攻撃対策
- `X-Content-Type-Options`: MIMEタイプスニッフィング防止
- `X-Frame-Options`: クリックジャッキング防止
- `Referrer-Policy`: リファラー情報の制御
- `Permissions-Policy`: ブラウザ機能の制限
- `Content-Security-Policy`: コンテンツセキュリティポリシー
- `Strict-Transport-Security`: HTTPS強制（本番環境）
- `Cross-Origin-Opener-Policy`: クロスオリジン保護
- `Cross-Origin-Resource-Policy`: リソース共有制御

### 7.9 Origin検証
- POSTリクエストのOriginヘッダー検証
- Server Actions保護
- 許可されたオリジンのホワイトリスト管理

### 7.10 Basic認証（オプション）
- 環境変数で有効/無効を制御
- ステージング環境での保護に使用
- APIルートは除外（Webhook対応）

---

## 8. SEO対策

### 8.1 メタデータ
- 各ページに適切なtitle, description設定
- Open Graphタグ対応
- Twitterカード対応

### 8.2 サイトマップ
- 動的サイトマップ生成（`app/sitemap.ts`）
- 主要ページの自動収集

### 8.3 robots.txt
- 検索エンジンクローラー制御（`public/robots.txt`）
- 管理画面、API、プライベートページの除外

```
User-agent: *
Allow: /
Disallow: /admin/
Disallow: /api/
Disallow: /settings/
Disallow: /_next/
Sitemap: https://bon-log.com/sitemap.xml
```

---

## 9. パフォーマンス

### 9.1 最適化施策
- Server Componentsによるサーバーサイドレンダリング
- React Queryによるキャッシュ管理
- next/imageによる画像最適化（WebP変換）
- カーソルベースページネーション
- Upstash Redisによるキャッシュ

### 9.2 目標値
- タイムライン読み込み: 1秒以内
- 画像表示: X（旧Twitter）並みの高速表示

---

## 10. テスト

### 10.1 テスト構成

| 種別 | ツール | 対象 | テスト数 |
|------|--------|------|---------|
| ユニットテスト | Jest + React Testing Library | コンポーネント、ユーティリティ、Server Actions | 約3,500件 |
| E2Eテスト | Playwright | ユーザーフロー | - |

### 10.2 テストコマンド

```bash
npm test                # ユニットテスト
npm run test:coverage   # カバレッジ付き
npm run test:e2e        # E2Eテスト
npm run test:all        # 全テスト実行
```

### 10.3 CI/CD（GitHub Actions）

| ジョブ | 内容 | 実行タイミング |
|--------|------|--------------|
| lint | ESLint + TypeScript型チェック | 常時 |
| test | ユニットテスト | 常時 |
| build | ビルド確認 | 常時 |
| e2e | E2Eテスト（Playwright） | mainのみ |

---

## 11. 運用コスト

### 11.1 初期段階（〜100ユーザー）

| サービス | プラン | 月額 |
|---------|--------|------|
| Vercel | Pro | $20 |
| Supabase | Free | $0 |
| Upstash | Free | $0 |
| Cloudflare R2 | Free枠 | $0 |
| Resend | Free | $0 |
| Sentry | Free | $0 |
| **合計** | | **約$20（¥3,000）** |

### 11.2 成長期（〜1,000ユーザー）

| サービス | プラン | 月額 |
|---------|--------|------|
| Vercel | Pro | $20 |
| Supabase | Pro | $25 |
| Upstash | Pay as you go | $5 |
| Cloudflare R2 | 従量課金 | $5 |
| Resend | Pro | $20 |
| Stripe | 従量課金 | 決済額の3.6% |
| Sentry | Free/Team | $0〜$26 |
| **合計** | | **約$75〜100（¥11,000〜15,000）** |

---

## 12. 環境変数

### 12.1 必須環境変数

```bash
# データベース（Supabase）
DATABASE_URL="postgresql://..."
DIRECT_URL="postgresql://..."

# 認証
NEXTAUTH_URL="https://www.bon-log.com"
NEXTAUTH_SECRET="..."

# アプリケーション
NEXT_PUBLIC_APP_URL="https://www.bon-log.com"

# Redis（Upstash）
UPSTASH_REDIS_REST_URL="https://..."
UPSTASH_REDIS_REST_TOKEN="..."

# エラー監視（Sentry）
SENTRY_DSN="https://..."
NEXT_PUBLIC_SENTRY_DSN="https://..."

# 2段階認証
TWO_FACTOR_ENCRYPTION_KEY="..."  # 32バイトのhex文字列（node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"で生成）
```

### 12.2 オプション環境変数

```bash
# ストレージ（Cloudflare R2）
STORAGE_PROVIDER="r2"
R2_ACCOUNT_ID="..."
R2_ACCESS_KEY_ID="..."
R2_SECRET_ACCESS_KEY="..."
R2_BUCKET_NAME="..."
R2_PUBLIC_URL="..."

# メール（Resend）
EMAIL_PROVIDER="resend"
RESEND_API_KEY="..."

# 決済（Stripe）
STRIPE_SECRET_KEY="..."
STRIPE_WEBHOOK_SECRET="..."
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY="..."
STRIPE_PRICE_ID_MONTHLY="..."
STRIPE_PRICE_ID_YEARLY="..."

# 広告（Google AdSense）
NEXT_PUBLIC_ADSENSE_CLIENT_ID="..."
NEXT_PUBLIC_ADSENSE_SLOT_SIDEBAR="..."
NEXT_PUBLIC_ADSENSE_SLOT_FEED="..."

# Basic認証（ステージング環境用）
BASIC_AUTH_USER="..."
BASIC_AUTH_PASSWORD="..."
```

---

## 13. 将来の拡張案

| 機能 | 優先度 | 説明 |
|------|--------|------|
| リアルタイム通知 | 高 | WebSocketによるプッシュ通知 |
| PWA対応 | 高 | オフライン対応、ホーム画面追加 |
| 多言語対応 | 中 | 英語、中国語対応 |
| AI機能 | 中 | 樹種の画像認識、育成アドバイス |
| マーケットプレイス | 低 | 盆栽・用品の売買機能 |
| ライブ配信 | 低 | 展示会などのリアルタイム配信 |

---

## 14. 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-01-05 | 初版作成 |
| 2025-01-09 | Azure App Service → Azure Container Apps |
| 2025-01-17 | Azure → Vercel/Supabase/R2 構成に変更 |
| 2025-01-19 | 実装状況に基づき全面改訂 |
| 2025-01-21 | 独自ドメイン(bon-log.com)設定、特定商取引法ページ追加 |
| 2026-01-26 | セキュリティ機能追加（ファイル検証、レート制限、サニタイズ等）、AdSense実装、フォローリクエスト機能、SEO対策、About/Contactページ追加、テスト構成追加 |
| 2026-01-27 | パスワードポリシー強化（英数字必須）、2段階認証（TOTP）実装、メールアドレス/デバイスブラックリスト機能追加 |
| 2026-01-29 | メンテナンスモード機能追加、system_settingsテーブル追加、テスト数約3,500件に拡充 |
