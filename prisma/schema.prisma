// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// NextAuth.js用モデル
model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// パスワードリセットトークン
model PasswordResetToken {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([email, token])
  @@map("password_reset_tokens")
}

// ユーザー関連
model User {
  id               String    @id @default(cuid())
  email            String    @unique
  emailVerified    DateTime? @map("email_verified")
  password         String?   // パスワードハッシュ
  nickname         String
  avatarUrl        String?   @map("avatar_url")
  headerUrl        String?   @map("header_url")
  bio              String?
  location         String?
  bonsaiStartYear  Int?      @map("bonsai_start_year")  // 盆栽を始めた年（任意）
  bonsaiStartMonth Int?      @map("bonsai_start_month") // 盆栽を始めた月（任意）
  birthDate        DateTime? @map("birth_date") @db.Date // 生年月日（任意）
  isPublic         Boolean   @default(true) @map("is_public")
  isSuspended      Boolean   @default(false) @map("is_suspended")
  suspendedAt      DateTime? @map("suspended_at")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  // 有料会員
  isPremium            Boolean   @default(false) @map("is_premium")
  premiumExpiresAt     DateTime? @map("premium_expires_at")
  stripeCustomerId     String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId String?   @unique @map("stripe_subscription_id")

  // 2段階認証（2FA）
  twoFactorEnabled     Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret      String?   @map("two_factor_secret") // 暗号化されたTOTPシークレット
  twoFactorBackupCodes String[]  @map("two_factor_backup_codes") // ハッシュ化されたバックアップコード

  // NextAuth.js relations
  accounts Account[]
  sessions Session[]

  // App relations
  posts        Post[]
  comments     Comment[]
  likes        Like[]
  bookmarks    Bookmark[]
  followers    Follow[]       @relation("FollowingToUser")
  following    Follow[]       @relation("FollowerToUser")
  blockedBy    Block[]        @relation("BlockedUser")
  blocking     Block[]        @relation("BlockingUser")
  mutedBy      Mute[]         @relation("MutedUser")
  muting       Mute[]         @relation("MutingUser")
  followRequestsSent     FollowRequest[] @relation("FollowRequestSent")
  followRequestsReceived FollowRequest[] @relation("FollowRequestReceived")
  notifications    Notification[] @relation("NotificationUser")
  actorNotifications Notification[] @relation("NotificationActor")
  shopReviews  ShopReview[]
  bonsaiShops  BonsaiShop[]
  events       Event[]
  reports      Report[]

  // Admin
  adminUser    AdminUser?

  // DM
  conversationParticipants ConversationParticipant[]
  sentMessages             Message[]

  // Premium
  scheduledPosts ScheduledPost[]
  payments       Payment[]

  // 下書き
  draftPosts     DraftPost[]

  // 盆栽
  bonsais        Bonsai[]

  // 盆栽園変更リクエスト
  shopChangeRequests ShopChangeRequest[]

  // アナリティクス
  analytics UserAnalytics[]

  @@map("users")
}

// 投稿関連
model Post {
  id           String    @id @default(cuid())
  userId       String    @map("user_id")
  content      String?   @db.Text
  quotePostId  String?   @map("quote_post_id")
  repostPostId String?   @map("repost_post_id")
  bonsaiId     String?   @map("bonsai_id")
  isHidden     Boolean   @default(false) @map("is_hidden")
  hiddenAt     DateTime? @map("hidden_at")
  createdAt    DateTime  @default(now()) @map("created_at")

  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotePost   Post?      @relation("QuotePost", fields: [quotePostId], references: [id], onDelete: SetNull)
  quotedBy    Post[]     @relation("QuotePost")
  repostPost  Post?      @relation("RepostPost", fields: [repostPostId], references: [id], onDelete: SetNull)
  repostedBy  Post[]     @relation("RepostPost")
  bonsai      Bonsai?    @relation(fields: [bonsaiId], references: [id], onDelete: SetNull)
  media       PostMedia[]
  genres      PostGenre[]
  comments    Comment[]
  likes       Like[]
  bookmarks   Bookmark[]
  notifications Notification[]
  scheduledPost ScheduledPost?
  hashtags    PostHashtag[]

  @@index([userId])
  @@index([createdAt])
  @@index([isHidden])
  @@index([bonsaiId])
  // パフォーマンス最適化: タイムラインクエリ用の複合インデックス
  @@index([userId, isHidden, createdAt(sort: Desc)])
  @@map("posts")
}

model PostMedia {
  id        String   @id @default(cuid())
  postId    String   @map("post_id")
  url       String
  type      String   // 'image' or 'video'
  sortOrder Int      @default(0) @map("sort_order")

  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("post_media")
}

model Genre {
  id        String   @id @default(cuid())
  name      String
  category  String
  type      String   @default("post") // "post" or "shop"
  sortOrder Int      @default(0) @map("sort_order")

  postGenres          PostGenre[]
  shopGenres          ShopGenre[]
  scheduledPostGenres ScheduledPostGenre[]
  draftPostGenres     DraftPostGenre[]

  @@map("genres")
}

model PostGenre {
  postId  String @map("post_id")
  genreId String @map("genre_id")

  post  Post  @relation(fields: [postId], references: [id], onDelete: Cascade)
  genre Genre @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([postId, genreId])
  @@map("post_genres")
}

// コメント
model Comment {
  id        String    @id @default(cuid())
  postId    String    @map("post_id")
  userId    String    @map("user_id")
  parentId  String?   @map("parent_id")
  content   String    @db.Text
  isHidden  Boolean   @default(false) @map("is_hidden")
  hiddenAt  DateTime? @map("hidden_at")
  createdAt DateTime  @default(now()) @map("created_at")

  post    Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  user    User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent  Comment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies Comment[] @relation("CommentReplies")
  likes   Like[]
  media   CommentMedia[]
  notifications Notification[]

  @@index([postId])
  @@index([userId])
  @@map("comments")
}

// コメントメディア
model CommentMedia {
  id        String @id @default(cuid())
  commentId String @map("comment_id")
  url       String
  type      String // 'image' or 'video'
  sortOrder Int    @default(0) @map("sort_order")

  comment Comment @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@map("comment_media")
}

// いいね
model Like {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  postId    String?  @map("post_id")
  commentId String?  @map("comment_id")
  createdAt DateTime @default(now()) @map("created_at")

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@unique([userId, commentId])
  @@index([postId])
  @@map("likes")
}

// ブックマーク
model Bookmark {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  postId    String   @map("post_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("bookmarks")
}

// フォロー
model Follow {
  followerId  String   @map("follower_id")
  followingId String   @map("following_id")
  createdAt   DateTime @default(now()) @map("created_at")

  follower  User @relation("FollowerToUser", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation("FollowingToUser", fields: [followingId], references: [id], onDelete: Cascade)

  @@id([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
  @@map("follows")
}

// ブロック
model Block {
  blockerId String   @map("blocker_id")
  blockedId String   @map("blocked_id")
  createdAt DateTime @default(now()) @map("created_at")

  blocker User @relation("BlockingUser", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation("BlockedUser", fields: [blockedId], references: [id], onDelete: Cascade)

  @@id([blockerId, blockedId])
  @@map("blocks")
}

// ミュート
model Mute {
  muterId String   @map("muter_id")
  mutedId String   @map("muted_id")
  createdAt DateTime @default(now()) @map("created_at")

  muter User @relation("MutingUser", fields: [muterId], references: [id], onDelete: Cascade)
  muted User @relation("MutedUser", fields: [mutedId], references: [id], onDelete: Cascade)

  @@id([muterId, mutedId])
  @@map("mutes")
}

// フォローリクエスト（非公開アカウント用）
model FollowRequest {
  id          String   @id @default(cuid())
  requesterId String   @map("requester_id")  // リクエスト送信者
  targetId    String   @map("target_id")     // リクエスト受信者（非公開アカウント）
  status      String   @default("pending")   // pending, approved, rejected
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  requester User @relation("FollowRequestSent", fields: [requesterId], references: [id], onDelete: Cascade)
  target    User @relation("FollowRequestReceived", fields: [targetId], references: [id], onDelete: Cascade)

  @@unique([requesterId, targetId])
  @@index([requesterId])
  @@index([targetId])
  @@index([status])
  @@map("follow_requests")
}

// 通知
model Notification {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  actorId   String   @map("actor_id")
  type      String   // 'like', 'comment', 'follow', 'quote', 'reply', 'comment_like'
  postId    String?  @map("post_id")
  commentId String?  @map("comment_id")
  isRead    Boolean  @default(false) @map("is_read")
  createdAt DateTime @default(now()) @map("created_at")

  user    User     @relation("NotificationUser", fields: [userId], references: [id], onDelete: Cascade)
  actor   User     @relation("NotificationActor", fields: [actorId], references: [id], onDelete: Cascade)
  post    Post?    @relation(fields: [postId], references: [id], onDelete: Cascade)
  comment Comment? @relation(fields: [commentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("notifications")
}

// 盆栽園
model BonsaiShop {
  id            String    @id @default(cuid())
  name          String
  address       String
  latitude      Decimal?  @db.Decimal(10, 7)
  longitude     Decimal?  @db.Decimal(10, 7)
  phone         String?
  website       String?
  businessHours String?   @map("business_hours")
  closedDays    String?   @map("closed_days")
  isHidden      Boolean   @default(false) @map("is_hidden")
  hiddenAt      DateTime? @map("hidden_at")
  createdBy     String    @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  creator        User                @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  genres         ShopGenre[]
  reviews        ShopReview[]
  changeRequests ShopChangeRequest[]

  @@index([isHidden])
  @@map("bonsai_shops")
}

model ShopGenre {
  shopId  String @map("shop_id")
  genreId String @map("genre_id")

  shop  BonsaiShop @relation(fields: [shopId], references: [id], onDelete: Cascade)
  genre Genre      @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([shopId, genreId])
  @@map("shop_genres")
}

model ShopReview {
  id        String    @id @default(cuid())
  shopId    String    @map("shop_id")
  userId    String    @map("user_id")
  rating    Int       // 1-5
  content   String?   @db.Text
  isHidden  Boolean   @default(false) @map("is_hidden")
  hiddenAt  DateTime? @map("hidden_at")
  createdAt DateTime  @default(now()) @map("created_at")

  shop   BonsaiShop        @relation(fields: [shopId], references: [id], onDelete: Cascade)
  user   User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  images ShopReviewImage[]

  @@index([isHidden])
  @@map("shop_reviews")
}

model ShopReviewImage {
  id       String @id @default(cuid())
  reviewId String @map("review_id")
  url      String

  review ShopReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)

  @@map("shop_review_images")
}

// 盆栽園変更リクエスト
model ShopChangeRequest {
  id               String    @id @default(cuid())
  shopId           String    @map("shop_id")
  userId           String    @map("user_id")
  status           String    @default("pending") // pending, approved, rejected
  requestedChanges Json      @map("requested_changes") // { name?, address?, phone?, website?, businessHours?, closedDays? }
  reason           String?   @db.Text // 変更理由
  adminComment     String?   @db.Text @map("admin_comment") // 管理者のコメント
  resolvedAt       DateTime? @map("resolved_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  shop BonsaiShop @relation(fields: [shopId], references: [id], onDelete: Cascade)
  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([shopId])
  @@index([userId])
  @@index([status])
  @@map("shop_change_requests")
}

// イベント
model Event {
  id           String    @id @default(cuid())
  title        String
  description  String?   @db.Text
  startDate    DateTime  @map("start_date")
  endDate      DateTime? @map("end_date")
  prefecture   String?
  city         String?
  venue        String?
  organizer    String?
  admissionFee String?   @map("admission_fee")
  hasSales     Boolean   @default(false) @map("has_sales")
  externalUrl  String?   @map("external_url")
  isHidden     Boolean   @default(false) @map("is_hidden")
  hiddenAt     DateTime? @map("hidden_at")
  createdBy    String    @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")

  creator User @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@index([startDate])
  @@index([prefecture])
  @@index([isHidden])
  @@map("events")
}

// 通報
model Report {
  id          String   @id @default(cuid())
  reporterId  String   @map("reporter_id")
  targetType  String   @map("target_type") // 'post', 'comment', 'event', 'shop', 'review', 'user'
  targetId    String   @map("target_id")
  reason      String   // 'spam', 'inappropriate', 'harassment', 'copyright', 'other'
  description String?  @db.Text
  status      String   @default("pending") // 'pending', 'reviewed', 'resolved', 'auto_hidden'
  createdAt   DateTime @default(now()) @map("created_at")

  reporter User @relation(fields: [reporterId], references: [id], onDelete: Cascade)

  @@index([targetType, targetId])
  @@index([status])
  @@map("reports")
}

// 管理者
model AdminUser {
  userId    String   @id @map("user_id")
  role      String   // 'admin', 'moderator'
  createdAt DateTime @default(now()) @map("created_at")

  user User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  logs AdminLog[]

  @@map("admin_users")
}

model AdminLog {
  id         String   @id @default(cuid())
  adminId    String   @map("admin_id")
  action     String
  targetType String?  @map("target_type")
  targetId   String?  @map("target_id")
  details    Json?
  createdAt  DateTime @default(now()) @map("created_at")

  admin AdminUser @relation(fields: [adminId], references: [userId], onDelete: Cascade)

  @@map("admin_logs")
}

// 管理者通知（自動非表示など）
model AdminNotification {
  id          String   @id @default(cuid())
  type        String   // 'auto_hidden', 'report_threshold', etc.
  targetType  String   @map("target_type") // 'post', 'comment', 'event', 'shop', 'review'
  targetId    String   @map("target_id")
  message     String
  reportCount Int      @map("report_count")
  isRead      Boolean  @default(false) @map("is_read")
  isResolved  Boolean  @default(false) @map("is_resolved")
  resolvedAt  DateTime? @map("resolved_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([isRead])
  @@index([isResolved])
  @@index([createdAt])
  @@map("admin_notifications")
}

// ダイレクトメッセージ
model Conversation {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  participants ConversationParticipant[]
  messages     Message[]

  @@map("conversations")
}

model ConversationParticipant {
  conversationId String    @map("conversation_id")
  userId         String    @map("user_id")
  joinedAt       DateTime  @default(now()) @map("joined_at")
  lastReadAt     DateTime? @map("last_read_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([conversationId, userId])
  @@map("conversation_participants")
}

model Message {
  id             String   @id @default(cuid())
  conversationId String   @map("conversation_id")
  senderId       String   @map("sender_id")
  content        String   @db.Text
  createdAt      DateTime @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

// 有料会員 - 支払い履歴
model Payment {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  stripePaymentId String   @unique @map("stripe_payment_id")
  amount          Int      // 金額（円）
  currency        String   @default("jpy")
  status          String   // succeeded, pending, failed
  description     String?
  createdAt       DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("payments")
}

// 有料会員 - 予約投稿
model ScheduledPost {
  id              String              @id @default(cuid())
  userId          String              @map("user_id")
  content         String?             @db.Text
  scheduledAt     DateTime            @map("scheduled_at")
  status          ScheduledPostStatus @default(pending)
  publishedPostId String?             @unique @map("published_post_id")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")

  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  publishedPost Post?                @relation(fields: [publishedPostId], references: [id], onDelete: SetNull)
  media         ScheduledPostMedia[]
  genres        ScheduledPostGenre[]

  @@index([userId])
  @@index([scheduledAt])
  @@index([status])
  @@map("scheduled_posts")
}

enum ScheduledPostStatus {
  pending   // 予約中
  published // 公開済み
  failed    // 公開失敗
  cancelled // キャンセル
}

model ScheduledPostMedia {
  id              String @id @default(cuid())
  scheduledPostId String @map("scheduled_post_id")
  url             String
  type            String @default("image")
  sortOrder       Int    @default(0) @map("sort_order")

  scheduledPost ScheduledPost @relation(fields: [scheduledPostId], references: [id], onDelete: Cascade)

  @@index([scheduledPostId])
  @@map("scheduled_post_media")
}

model ScheduledPostGenre {
  scheduledPostId String @map("scheduled_post_id")
  genreId         String @map("genre_id")

  scheduledPost ScheduledPost @relation(fields: [scheduledPostId], references: [id], onDelete: Cascade)
  genre         Genre         @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([scheduledPostId, genreId])
  @@map("scheduled_post_genres")
}

// 下書き投稿
model DraftPost {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  content   String?  @db.Text
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  media  DraftPostMedia[]
  genres DraftPostGenre[]

  @@index([userId])
  @@map("draft_posts")
}

model DraftPostMedia {
  id          String @id @default(cuid())
  draftPostId String @map("draft_post_id")
  url         String
  type        String @default("image")
  sortOrder   Int    @default(0) @map("sort_order")

  draftPost DraftPost @relation(fields: [draftPostId], references: [id], onDelete: Cascade)

  @@index([draftPostId])
  @@map("draft_post_media")
}

model DraftPostGenre {
  draftPostId String @map("draft_post_id")
  genreId     String @map("genre_id")

  draftPost DraftPost @relation(fields: [draftPostId], references: [id], onDelete: Cascade)
  genre     Genre     @relation(fields: [genreId], references: [id], onDelete: Cascade)

  @@id([draftPostId, genreId])
  @@map("draft_post_genres")
}

// ハッシュタグ
model Hashtag {
  id        String   @id @default(cuid())
  name      String   @unique
  count     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  posts PostHashtag[]

  @@index([count])
  @@map("hashtags")
}

model PostHashtag {
  postId    String @map("post_id")
  hashtagId String @map("hashtag_id")

  post    Post    @relation(fields: [postId], references: [id], onDelete: Cascade)
  hashtag Hashtag @relation(fields: [hashtagId], references: [id], onDelete: Cascade)

  @@id([postId, hashtagId])
  @@map("post_hashtags")
}

// 盆栽成長記録
model Bonsai {
  id          String    @id @default(cuid())
  userId      String    @map("user_id")
  name        String
  species     String?
  acquiredAt  DateTime? @map("acquired_at")
  description String?   @db.Text
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  user    User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  records BonsaiRecord[]
  posts   Post[]

  @@index([userId])
  @@map("bonsais")
}

model BonsaiRecord {
  id        String   @id @default(cuid())
  bonsaiId  String   @map("bonsai_id")
  content   String?  @db.Text
  recordAt  DateTime @default(now()) @map("record_at")
  createdAt DateTime @default(now()) @map("created_at")

  bonsai Bonsai             @relation(fields: [bonsaiId], references: [id], onDelete: Cascade)
  images BonsaiRecordImage[]

  @@index([bonsaiId])
  @@index([recordAt])
  @@map("bonsai_records")
}

model BonsaiRecordImage {
  id       String @id @default(cuid())
  recordId String @map("record_id")
  url      String
  sortOrder Int   @default(0) @map("sort_order")

  record BonsaiRecord @relation(fields: [recordId], references: [id], onDelete: Cascade)

  @@map("bonsai_record_images")
}

// ユーザーアナリティクス
model UserAnalytics {
  id            String   @id @default(cuid())
  userId        String   @map("user_id")
  date          DateTime @db.Date
  profileViews  Int      @default(0) @map("profile_views")
  postViews     Int      @default(0) @map("post_views")
  likesReceived Int      @default(0) @map("likes_received")
  newFollowers  Int      @default(0) @map("new_followers")
  createdAt     DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([userId])
  @@index([date])
  @@map("user_analytics")
}

// メールアドレスブラックリスト
model EmailBlacklist {
  id        String   @id @default(cuid())
  email     String   @unique
  reason    String?  @db.Text // ブロック理由（管理用メモ）
  createdBy String   @map("created_by") // 登録した管理者ID
  createdAt DateTime @default(now()) @map("created_at")

  @@index([email])
  @@map("email_blacklist")
}

// デバイスブラックリスト（フィンガープリントベース）
model DeviceBlacklist {
  id            String   @id @default(cuid())
  fingerprint   String   @unique // デバイスフィンガープリント（ハッシュ）
  reason        String?  @db.Text // ブロック理由
  originalEmail String?  @map("original_email") // 元のブロックユーザーのメール（参考用）
  createdBy     String   @map("created_by") // 登録した管理者ID
  createdAt     DateTime @default(now()) @map("created_at")

  @@index([fingerprint])
  @@map("device_blacklist")
}

// ユーザーのデバイス履歴（デバイスフィンガープリント記録用）
model UserDevice {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  fingerprint String   // デバイスフィンガープリント
  userAgent   String?  @map("user_agent") @db.Text
  ipAddress   String?  @map("ip_address")
  lastSeenAt  DateTime @default(now()) @map("last_seen_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@unique([userId, fingerprint])
  @@index([userId])
  @@index([fingerprint])
  @@map("user_devices")
}

// システム設定（メンテナンスモード等）
model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique // 設定キー（例: maintenance_mode）
  value     Json     // 設定値（JSON形式）
  updatedBy String?  @map("updated_by") // 最後に更新した管理者ID
  updatedAt DateTime @updatedAt @map("updated_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@map("system_settings")
}
